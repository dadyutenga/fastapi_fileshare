{% extends "layout.html" %}
{% block title %}My Files - FileShare Portal{% endblock %}
{% block content %}
<div class="px-4 sm:px-0">
    <div class="sm:flex sm:items-center sm:justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fas fa-folder text-primary mr-2"></i>
                My Files
            </h1>
            <p class="text-gray-600 mt-2">Manage your uploaded files</p>
        </div>
        <div class="mt-4 sm:mt-0 flex space-x-3">
            <a href="/" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700 transition-colors">
                <i class="fas fa-upload mr-2"></i>
                Upload New File
            </a>
            
            <!-- Delete All Files Button -->
            {% if files %}
            <button onclick="confirmDeleteAll()" 
                    class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 transition-colors"
                    title="Delete all your files">
                <i class="fas fa-trash-alt mr-2"></i>
                Delete All Files
            </button>
            {% endif %}
        </div>
    </div>

    {% if files %}
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">
                        Your Files ({{ files|length }} total)
                    </h3>
                    <div class="text-sm text-gray-500">
                        Total size: 
                        {% set total_size = files|sum(attribute='file_size') %}
                        {% if total_size > 1024*1024 %}
                            {{ "%.1f"|format(total_size / (1024*1024)) }} MB
                        {% elif total_size > 1024 %}
                            {{ "%.1f"|format(total_size / 1024) }} KB
                        {% else %}
                            {{ total_size }} B
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <ul class="divide-y divide-gray-200">
                {% for file in files %}
                    <li class="px-6 py-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center min-w-0 flex-1">
                                <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center">
                                    {% if file.content_type and file.content_type.startswith('image/') %}
                                        <i class="fas fa-image text-blue-500 text-xl"></i>
                                    {% elif file.content_type == 'application/pdf' %}
                                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                                    {% elif file.content_type and file.content_type.startswith('video/') %}
                                        <i class="fas fa-video text-purple-500 text-xl"></i>
                                    {% elif file.content_type and file.content_type.startswith('audio/') %}
                                        <i class="fas fa-music text-green-500 text-xl"></i>
                                    {% elif file.content_type and file.content_type.startswith('text/') %}
                                        <i class="fas fa-file-alt text-gray-500 text-xl"></i>
                                    {% elif file.content_type in ['application/zip', 'application/x-rar-compressed', 'application/x-7z-compressed'] %}
                                        <i class="fas fa-file-archive text-orange-500 text-xl"></i>
                                    {% elif file.content_type in ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'] %}
                                        <i class="fas fa-file-word text-blue-600 text-xl"></i>
                                    {% elif file.content_type in ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'] %}
                                        <i class="fas fa-file-excel text-green-600 text-xl"></i>
                                    {% else %}
                                        <i class="fas fa-file text-gray-400 text-xl"></i>
                                    {% endif %}
                                </div>
                                <div class="ml-4 min-w-0 flex-1">
                                    <div class="flex items-center">
                                        <p class="text-sm font-medium text-gray-900 truncate">{{ file.original_filename }}</p>
                                        {% if file.is_public %}
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-globe mr-1"></i>
                                                Public
                                            </span>
                                        {% else %}
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                <i class="fas fa-lock mr-1"></i>
                                                Private
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center mt-1 text-sm text-gray-500">
                                        <span>
                                            {% if file.file_size > 1024*1024 %}
                                                {{ "%.1f"|format(file.file_size / (1024*1024)) }} MB
                                            {% elif file.file_size > 1024 %}
                                                {{ "%.1f"|format(file.file_size / 1024) }} KB
                                            {% else %}
                                                {{ file.file_size }} B
                                            {% endif %}
                                        </span>
                                        <span class="mx-2">•</span>
                                        <span>{{ file.upload_time.strftime('%Y-%m-%d %H:%M') }}</span>
                                        <span class="mx-2">•</span>
                                        <span>
                                            <i class="fas fa-download mr-1"></i>
                                            {{ file.download_count }} downloads
                                        </span>
                                        {% if file.ttl > 0 %}
                                        <span class="mx-2">•</span>
                                        <span class="text-orange-600">
                                            <i class="fas fa-clock mr-1"></i>
                                            Expires in {{ file.ttl }}h
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <a href="/files/preview/{{ file.file_id }}" 
                                   class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50"
                                   title="Preview file">
                                    <i class="fas fa-eye mr-1"></i>
                                    Preview
                                </a>
                                <a href="/files/download/{{ file.file_id }}" 
                                   class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-white bg-green-600 hover:bg-green-700"
                                   title="Download file">
                                    <i class="fas fa-download mr-1"></i>
                                    Download
                                </a>
                                
                                <!-- Copy Link Button - Only show for PUBLIC files -->
                                {% if file.is_public %}
                                <button data-copy-url="{{ request.url_for('download_file', file_id=file.file_id) }}" 
                                        onclick="copyToClipboard(this.dataset.copyUrl)"
                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-purple-700 bg-purple-50 hover:bg-purple-100"
                                        title="Copy public download link">
                                    <i class="fas fa-link mr-1"></i>
                                    Copy Public Link
                                </button>
                                {% else %}
                                <span class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-400 bg-gray-50 cursor-not-allowed"
                                      title="Private file - no public link available">
                                    <i class="fas fa-lock mr-1"></i>
                                    Private File
                                </span>
                                {% endif %}
                                
                                <form action="/files/toggle-privacy/{{ file.file_id }}" method="post" class="inline">
                                    <button type="submit" 
                                            class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50"
                                            title="Toggle privacy ({{ 'Make Private' if file.is_public else 'Make Public' }})">
                                        {% if file.is_public %}
                                            <i class="fas fa-lock mr-1"></i>
                                            Make Private
                                        {% else %}
                                            <i class="fas fa-globe mr-1"></i>
                                            Make Public
                                        {% endif %}
                                    </button>
                                </form>
                                <form action="/files/delete/{{ file.file_id }}" method="post" class="inline" 
                                      onsubmit="return confirm('Are you sure you want to delete this file?')">
                                    <button type="submit" 
                                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-white bg-red-600 hover:bg-red-700"
                                            title="Delete file">
                                        <i class="fas fa-trash mr-1"></i>
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% else %}
        <div class="text-center py-12">
            <i class="fas fa-file-upload text-gray-300 text-6xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No files uploaded yet</h3>
            <p class="text-gray-500 mb-6">Get started by uploading your first file to share with others</p>
            <a href="/" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-blue-700 transition-colors">
                <i class="fas fa-upload mr-2"></i>
                Upload Your First File
            </a>
        </div>
    {% endif %}
</div>

<!-- Delete All Confirmation Modal -->
<div id="deleteAllModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4">Delete All Files</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete <strong>ALL</strong> your files? This action cannot be undone and all files will be permanently deleted.
                </p>
                <div class="bg-red-50 border border-red-200 rounded-md p-3 mt-4">
                    <div class="flex">
                        <i class="fas fa-exclamation-circle text-red-400 mr-2 mt-0.5"></i>
                        <div class="text-sm text-red-700">
                            <strong>Warning:</strong> This will delete all {{ files|length if files else 0 }} files permanently.
                        </div>
                    </div>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <div class="flex space-x-3">
                    <button id="confirmDeleteAll" 
                            onclick="executeDeleteAll()"
                            class="flex-1 px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <i class="fas fa-trash mr-2"></i>
                        Yes, Delete All
                    </button>
                    <button onclick="closeDeleteAllModal()" 
                            class="flex-1 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        toast.innerHTML = '<i class="fas fa-check mr-2"></i>Public download link copied to clipboard!';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        toast.innerHTML = '<i class="fas fa-check mr-2"></i>Public download link copied to clipboard!';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    });
}

// Delete All Functions
function confirmDeleteAll() {
    document.getElementById('deleteAllModal').classList.remove('hidden');
}

function closeDeleteAllModal() {
    document.getElementById('deleteAllModal').classList.add('hidden');
}

async function executeDeleteAll() {
    const confirmBtn = document.getElementById('confirmDeleteAll');
    const originalText = confirmBtn.innerHTML;
    
    // Show loading state
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
    
    try {
        const response = await fetch('/files/delete-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Show success message
            showToast('success', `Successfully deleted ${data.deleted_count} files!`);
            
            // Close modal and reload page after a short delay
            closeDeleteAllModal();
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(data.message || 'Failed to delete files');
        }
    } catch (error) {
        console.error('Delete all failed:', error);
        showToast('error', 'Failed to delete files: ' + error.message);
        
        // Reset button state
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
    }
}

function showToast(type, message) {
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const icon = type === 'success' ? 'fas fa-check' : 'fas fa-exclamation-triangle';
    
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.innerHTML = `<i class="${icon} mr-2"></i>${message}`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Close modal when clicking outside
document.getElementById('deleteAllModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteAllModal();
    }
});
</script>
{% endblock %}