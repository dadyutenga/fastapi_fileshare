{% extends "admin/layout.html" %}
{% block title %}Manage Files - FileShare Portal{% endblock %}
{% block page_title %}File Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Search -->
    <div class="bg-white shadow rounded-lg p-6">
        <form method="GET" class="flex space-x-4">
            <div class="flex-1">
                <label for="search" class="block text-sm font-medium text-gray-700">Search Files</label>
                <input type="text" name="search" id="search" value="{{ search or '' }}" 
                       placeholder="Filename or owner..."
                       class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-primary focus:border-primary">
            </div>
            <div class="flex items-end">
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-coral-dark transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    Search
                </button>
            </div>
        </form>
    </div>

    <!-- Files Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">
                Files ({{ total }} total)
            </h3>
        </div>
        
        {% if files %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Privacy</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Downloads</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for file in files %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 flex items-center justify-center">
                                    {% if file.content_type and file.content_type.startswith('image/') %}
                                        <i class="fas fa-image text-blue-500"></i>
                                    {% elif file.content_type == 'application/pdf' %}
                                        <i class="fas fa-file-pdf text-red-500"></i>
                                    {% elif file.content_type and file.content_type.startswith('video/') %}
                                        <i class="fas fa-video text-purple-500"></i>
                                    {% elif file.content_type and file.content_type.startswith('audio/') %}
                                        <i class="fas fa-music text-green-500"></i>
                                    {% else %}
                                        <i class="fas fa-file text-gray-500"></i>
                                    {% endif %}
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-medium text-gray-900 max-w-xs truncate">
                                        {{ file.original_filename }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ID: {{ file.file_id[:8] }}...
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ file.owner.username if file.owner else 'Unknown' }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if file.file_size > 1024*1024 %}
                                {{ "%.1f"|format(file.file_size / (1024*1024)) }} MB
                            {% elif file.file_size > 1024 %}
                                {{ "%.1f"|format(file.file_size / 1024) }} KB
                            {% else %}
                                {{ file.file_size }} B
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ file.content_type.split('/')[1] if file.content_type and '/' in file.content_type else (file.content_type or 'unknown') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if file.is_public %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-globe mr-1"></i>Public
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-lock mr-1"></i>Private
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ file.download_count }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ file.upload_time.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <a href="/files/preview/{{ file.file_id }}" target="_blank"
                               class="inline-flex items-center px-2 py-1 text-xs font-medium rounded text-blue-700 bg-blue-50 hover:bg-blue-100">
                                <i class="fas fa-eye mr-1"></i>Preview
                            </a>
                            
                            {% if admin.has_permission(admin_permission.DELETE_ANY_FILE) %}
                            <button onclick="deleteFile('{{ file.file_id }}', '{{ file.original_filename }}')"
                                    class="inline-flex items-center px-2 py-1 text-xs font-medium rounded text-red-700 bg-red-50 hover:bg-red-100">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if pages > 1 %}
        <div class="bg-white px-6 py-3 border-t border-gray-200 flex items-center justify-between">
            <div class="text-sm text-gray-500">
                Showing {{ ((page - 1) * 50) + 1 }} to {{ page * 50 if page * 50 < total else total }} of {{ total }} files
            </div>
            <div class="flex space-x-2">
                {% if page > 1 %}
                <a href="?page={{ page - 1 }}&search={{ search or '' }}" 
                   class="px-3 py-1 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                    Previous
                </a>
                {% endif %}
                {% if page < pages %}
                <a href="?page={{ page + 1 }}&search={{ search or '' }}" 
                   class="px-3 py-1 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="px-6 py-4 text-center text-gray-500">
            No files found.
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">Delete File</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="deleteMessage"></p>
                <div class="mt-4">
                    <label for="deleteReason" class="block text-sm font-medium text-gray-700">Reason (optional)</label>
                    <textarea id="deleteReason" rows="2" 
                              class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-primary focus:border-primary text-sm"
                              placeholder="Enter reason for deletion..."></textarea>
                </div>
            </div>
            <div class="items-center px-4 py-3 space-x-3">
                <button id="confirmDelete" 
                        class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Delete File
                </button>
                <button onclick="closeDeleteModal()" 
                        class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentFileId = null;

function deleteFile(fileId, filename) {
    currentFileId = fileId;
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${filename}"? This action cannot be undone.`;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.getElementById('deleteReason').value = '';
    currentFileId = null;
}

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (!currentFileId) return;
    
    const reason = document.getElementById('deleteReason').value;
    const formData = new FormData();
    formData.append('reason', reason);
    
    fetch(`/admin/files/${currentFileId}`, {
        method: 'DELETE',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error deleting file: ' + error.message);
    })
    .finally(() => {
        closeDeleteModal();
    });
});

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>
{% endblock %}