{% extends "admin/layout.html" %}

{% block title %}Security Alerts - Admin Panel{% endblock %}
{% block page_title %}Security Alerts{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Security Overview -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Security Overview (Last 24 Hours)</h3>
        <div id="securityOverview" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600" id="totalAlerts">-</div>
                <div class="text-sm text-gray-500">Total Alerts</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-orange-600" id="bruteForceAttempts">-</div>
                <div class="text-sm text-gray-500">Brute Force Attempts</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-yellow-600" id="suspiciousIPs">-</div>
                <div class="text-sm text-gray-500">Suspicious IPs</div>
            </div>
        </div>
    </div>

    <!-- Active Threats -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Active Threats</h3>
        <div id="activeThreats">
            <div class="text-gray-500">Loading...</div>
        </div>
    </div>

    <!-- Recent Security Alerts -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">Security Alerts</h3>
            <div class="flex space-x-2">
                <select id="alertTypeFilter" class="rounded-md border-gray-300 shadow-sm text-sm">
                    <option value="">All Alert Types</option>
                    <option value="BRUTE_FORCE">Brute Force</option>
                    <option value="SUSPICIOUS_ACTIVITY">Suspicious Activity</option>
                    <option value="UNUSUAL_ACCESS">Unusual Access</option>
                </select>
                <button onclick="loadSecurityAlerts()" 
                        class="bg-primary text-white px-3 py-1 rounded text-sm hover:bg-coral-dark">
                    Refresh
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Source IP</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Target</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Severity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody id="alertsTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <span class="text-sm text-gray-700">
                        Showing <span id="currentRange">1-50</span> of <span id="totalCount">0</span> results
                    </span>
                </div>
                <div class="flex space-x-2">
                    <button onclick="previousPage()" id="prevBtn" 
                            class="bg-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-400 disabled:opacity-50">
                        Previous
                    </button>
                    <button onclick="nextPage()" id="nextBtn" 
                            class="bg-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-400 disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- IP Blacklist Management -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">IP Management</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Add IP to Blacklist -->
            <div>
                <h4 class="font-medium text-gray-900 mb-2">Block IP Address</h4>
                <div class="flex space-x-2">
                    <input type="text" id="blockIpInput" placeholder="Enter IP address" 
                           class="flex-1 rounded-md border-gray-300 shadow-sm">
                    <button onclick="blockIP()" 
                            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        Block
                    </button>
                </div>
            </div>
            
            <!-- Remove IP from Blacklist -->
            <div>
                <h4 class="font-medium text-gray-900 mb-2">Unblock IP Address</h4>
                <div class="flex space-x-2">
                    <input type="text" id="unblockIpInput" placeholder="Enter IP address" 
                           class="flex-1 rounded-md border-gray-300 shadow-sm">
                    <button onclick="unblockIP()" 
                            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Unblock
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 0;
let pageSize = 50;

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadSecurityOverview();
    loadActiveThreats();
    loadSecurityAlerts();
});

function loadSecurityOverview() {
    fetch('/admin/logs/security/overview')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalAlerts').textContent = data.total_alerts;
            document.getElementById('bruteForceAttempts').textContent = data.brute_force_attempts;
            document.getElementById('suspiciousIPs').textContent = data.suspicious_ips;
        })
        .catch(error => {
            console.error('Error loading security overview:', error);
        });
}

function loadActiveThreats() {
    fetch('/admin/logs/security/brute-force')
        .then(response => response.json())
        .then(data => {
            renderActiveThreats(data.alerts);
        })
        .catch(error => {
            console.error('Error loading active threats:', error);
            document.getElementById('activeThreats').innerHTML = 
                '<div class="text-red-500">Error loading active threats</div>';
        });
}

function renderActiveThreats(threats) {
    const container = document.getElementById('activeThreats');
    
    if (threats.length === 0) {
        container.innerHTML = '<div class="text-green-600 flex items-center"><i class="fas fa-shield-alt mr-2"></i>No active threats detected</div>';
        return;
    }
    
    container.innerHTML = threats.map(threat => {
        const time = new Date(threat.detected_at).toLocaleString();
        const severityClass = getSeverityClass(threat.severity || 'HIGH');
        
        return `
            <div class="border-l-4 border-red-400 bg-red-50 p-4 mb-2">
                <div class="flex justify-between items-start">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-red-800">Active Brute Force Attack</h4>
                            <div class="mt-2 text-sm text-red-700">
                                <p><strong>Source IP:</strong> ${threat.client_ip}</p>
                                <p><strong>Target:</strong> ${threat.target_username || 'Multiple users'}</p>
                                <p><strong>Attempts:</strong> ${threat.attempt_count}</p>
                                <p><strong>Detected:</strong> ${time}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="blockIP('${threat.client_ip}')" 
                                class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                            Block IP
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function loadSecurityAlerts() {
    const params = new URLSearchParams({
        limit: pageSize,
        offset: currentPage * pageSize
    });
    
    const alertTypeFilter = document.getElementById('alertTypeFilter').value;
    if (alertTypeFilter) params.append('alert_type', alertTypeFilter);
    
    fetch(`/admin/logs/security/alerts/api?${params}`)
        .then(response => response.json())
        .then(data => {
            renderAlertsTable(data.alerts);
            updatePagination(data.total);
        })
        .catch(error => {
            console.error('Error loading security alerts:', error);
            document.getElementById('alertsTableBody').innerHTML = 
                '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading security alerts</td></tr>';
        });
}

function renderAlertsTable(alerts) {
    const tbody = document.getElementById('alertsTableBody');
    
    if (alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No security alerts found</td></tr>';
        return;
    }
    
    tbody.innerHTML = alerts.map(alert => {
        const time = new Date(alert.detected_at).toLocaleString();
        const severityClass = getSeverityClass(alert.severity);
        const statusClass = alert.resolved ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const statusText = alert.resolved ? 'Resolved' : 'Active';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${time}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${alert.alert_type}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${alert.client_ip}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${alert.target_username || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${alert.details}">${alert.details}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${severityClass}">${alert.severity}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span>
                </td>
            </tr>
        `;
    }).join('');
}

function getSeverityClass(severity) {
    switch(severity) {
        case 'CRITICAL': return 'bg-red-100 text-red-800';
        case 'HIGH': return 'bg-orange-100 text-orange-800';
        case 'MEDIUM': return 'bg-yellow-100 text-yellow-800';
        case 'LOW': return 'bg-blue-100 text-blue-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function updatePagination(total) {
    const start = currentPage * pageSize + 1;
    const end = Math.min((currentPage + 1) * pageSize, total);
    
    document.getElementById('currentRange').textContent = `${start}-${end}`;
    document.getElementById('totalCount').textContent = total;
    
    document.getElementById('prevBtn').disabled = currentPage === 0;
    document.getElementById('nextBtn').disabled = end >= total;
}

function previousPage() {
    if (currentPage > 0) {
        currentPage--;
        loadSecurityAlerts();
    }
}

function nextPage() {
    currentPage++;
    loadSecurityAlerts();
}

function blockIP(ip = null) {
    const ipToBlock = ip || document.getElementById('blockIpInput').value.trim();
    if (!ipToBlock) {
        alert('Please enter an IP address to block');
        return;
    }
    
    if (!confirm(`Are you sure you want to block IP: ${ipToBlock}?`)) {
        return;
    }
    
    fetch('/admin/logs/security/block-ip', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ip_address: ipToBlock })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`IP ${ipToBlock} has been blocked successfully`);
            document.getElementById('blockIpInput').value = '';
            loadActiveThreats(); // Refresh threats
        } else {
            alert(`Error blocking IP: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error blocking IP:', error);
        alert('Error blocking IP address');
    });
}

function unblockIP() {
    const ipToUnblock = document.getElementById('unblockIpInput').value.trim();
    if (!ipToUnblock) {
        alert('Please enter an IP address to unblock');
        return;
    }
    
    if (!confirm(`Are you sure you want to unblock IP: ${ipToUnblock}?`)) {
        return;
    }
    
    fetch('/admin/logs/security/unblock-ip', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ip_address: ipToUnblock })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`IP ${ipToUnblock} has been unblocked successfully`);
            document.getElementById('unblockIpInput').value = '';
        } else {
            alert(`Error unblocking IP: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error unblocking IP:', error);
        alert('Error unblocking IP address');
    });
}
</script>
{% endblock %}